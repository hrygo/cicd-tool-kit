#!/bin/bash
# Pre-push hook for CI/CD Toolkit
# Runs full test suite before pushing to remote

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get the current branch
CURRENT_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "unknown")

# Get the remote being pushed to
REMOTE=$1
URL=$2

echo -e "${BLUE}Running pre-push checks for branch: $CURRENT_BRANCH${NC}"
echo ""

# Allow bypass with environment variable
if [ "$GIT_SKIP_PRE_PUSH" = "1" ]; then
    echo -e "${YELLOW}⚠ Skipping pre-push checks (GIT_SKIP_PRE_PUSH=1)${NC}"
    exit 0
fi

# Track failures
FAILURES=0

# 1. Full go test (non-short mode)
echo -e "${YELLOW}[1/2] Running full test suite...${NC}"
echo -e "${YELLOW}This may take a while...${NC}"
if ! go test ./... -timeout=5m 2>&1 | tail -10; then
    echo -e "${RED}✗ Full test suite failed${NC}"
    FAILURES=$((FAILURES + 1))
else
    echo -e "${GREEN}✓ All tests passed${NC}"
fi
echo ""

# 2. Build check
echo -e "${YELLOW}[2/2] Verifying build...${NC}"
if ! go build ./... 2>&1; then
    echo -e "${RED}✗ Build failed${NC}"
    FAILURES=$((FAILURES + 1))
else
    echo -e "${GREEN}✓ Build successful${NC}"
fi
echo ""

# Final result
if [ $FAILURES -gt 0 ]; then
    echo -e "${RED}✗ Pre-push checks failed ($FAILURES check(s) failed)${NC}"
    echo -e "${YELLOW}To bypass this hook, use: GIT_SKIP_PRE_PUSH=1 git push${NC}"
    exit 1
fi

echo -e "${GREEN}✓ All pre-push checks passed!${NC}"
exit 0

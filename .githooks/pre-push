#!/bin/sh
# Pre-push hook - full CI checks before pushing to remote
set -e

echo "ðŸš€ Running pre-push checks (full CI validation)..."
echo ""

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get pushed branch
REMOTE="$1"
URL="$2"

echo "Pushing to: $URL"
echo ""

# Backend full checks
echo "ðŸ“¦ Backend:"
echo "  â†’ go mod tidy check..."
cp go.mod go.mod.bak 2>/dev/null || true
cp go.sum go.sum.bak 2>/dev/null || true
go mod tidy
if ! git diff --quiet go.mod go.sum; then
    echo "    ${RED}âœ— go.mod/go.sum not tidy${NC}"
    echo "    Run: go mod tidy && git add go.mod go.sum"
    mv go.mod.bak go.mod 2>/dev/null || true
    mv go.sum.bak go.sum 2>/dev/null || true
    exit 1
fi
rm -f go.mod.bak go.sum.bak

echo "  â†’ golangci-lint..."
if command -v golangci-lint &> /dev/null; then
    if ! golangci-lint run --config=.golangci.yaml --timeout=3m; then
        echo "    ${RED}âœ— golangci-lint failed${NC}"
        echo "    Run 'golangci-lint run --config=.golangci.yaml' to fix"
        exit 1
    fi
else
    echo "    ${YELLOW}âš  golangci-lint not found, skipping...${NC}"
    echo "    ${YELLOW}  Install with: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest${NC}"
fi

echo "  â†’ go test..."
# Run tests with increased timeout
if ! go test -short -timeout=60s ./...; then
    echo "    ${RED}âœ— tests failed${NC}"
    exit 1
fi

echo "    ${GREEN}âœ“ Backend checks passed${NC}"
echo ""

echo ""
echo "${GREEN}âœ… All pre-push checks passed! Ready to push.${NC}"

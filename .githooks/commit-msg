#!/bin/bash
# Commit-msg hook for validating conventional commit format
# Based on: https://www.conventionalcommits.org/

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip validation for certain patterns
SKIP_PATTERNS=(
    "^wip:"
    "^WIP:"
    "^fixup!"
    "^squash!"
    "^[mM]erge"
    "^revert:"
    "^Initial commit"
    "^(fix|feat|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.*\))?:"
)

for pattern in "${SKIP_PATTERNS[@]}"; do
    if echo "$COMMIT_MSG" | grep -qE "$pattern"; then
        # Matches a valid pattern, skip validation
        exit 0
    fi
done

# Check if the commit message follows conventional commits format
# Format: type(scope): description
CONVENTIONAL_PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,72}"

if ! echo "$COMMIT_MSG" | head -n 1 | grep -qE "$CONVENTIONAL_PATTERN"; then
    echo -e "${YELLOW}âš  Commit message does not follow Conventional Commits format${NC}"
    echo ""
    echo "Expected format: <type>(<scope>): <description>"
    echo ""
    echo "Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
    echo "Scope: optional (e.g., auth, config, runner)"
    echo "Description: 1-72 characters, lowercase, no period at end"
    echo ""
    echo "Examples:"
    echo "  feat(auth): implement OIDC provider"
    echo "  fix(runner): resolve goroutine leak"
    echo "  docs: update README with usage examples"
    echo "  refactor(ai): simplify prompt building logic"
    echo ""
    echo -e "${YELLOW}To bypass this hook, use: git commit --no-verify${NC}"
    # Don't fail, just warn
    # exit 1
fi

exit 0

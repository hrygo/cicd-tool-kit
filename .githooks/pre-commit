#!/bin/sh
# Pre-commit hook - lightweight checks (fast feedback, ~2s)
set -e

echo "ðŸ” Quick pre-commit checks..."

# Get the list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

# If no Go files are staged, skip Go-specific checks
if [ -z "$STAGED_GO_FILES" ]; then
    echo "  â„¹  No Go files staged, skipping Go checks"
    exit 0
fi

# Check go.mod/go.sum are tidy
echo "  â†’ go.mod/go.sum tidy check..."
if ! go mod tidy -diff > /dev/null 2>&1; then
    echo ""
    echo "    âœ— go.mod/go.sum not tidy"
    echo "    Run: go mod tidy && git add go.mod go.sum"
    echo ""
    exit 1
fi
echo "    âœ“ go.mod/go.sum tidy"

# Check if files are properly formatted
echo "  â†’ go fmt check..."
UNFORMATTED=$(echo "$STAGED_GO_FILES" | xargs gofmt -l 2>/dev/null || true)
if [ -n "$UNFORMATTED" ]; then
    echo ""
    echo "    âœ— The following files are not properly formatted:"
    echo "$UNFORMATTED"
    echo "    Run: go fmt ./..."
    echo ""
    exit 1
fi
echo "    âœ“ go fmt"

# Run go vet
echo "  â†’ go vet..."
if ! go vet ./... 2>&1 | head -20; then
    echo ""
    echo "    âœ— go vet failed"
    echo ""
    exit 1
fi
echo "    âœ“ go vet"

echo "âœ… Pre-commit checks passed!"

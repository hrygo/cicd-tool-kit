{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://cicd.ai/toolkit/pm-state-schema.json",
  "title": "Project Manager State",
  "description": "项目状态单一真相源",
  "type": "object",
  "required": ["version", "updated_at", "developers", "specs", "locks", "worktrees"],
  "properties": {
    "version": {
      "type": "string",
      "description": "状态格式版本"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time",
      "description": "最后更新时间 (ISO 8601)"
    },
    "developers": {
      "type": "object",
      "description": "开发者配置和状态",
      "additionalProperties": {
        "type": "object",
        "required": ["id", "name", "namespace", "current_task", "completed_specs"],
        "properties": {
          "id": {"type": "string", "description": "开发者 ID (dev-a, dev-b, dev-c)"},
          "name": {"type": "string", "description": "角色名称"},
          "namespace": {
            "type": "array",
            "items": {"type": "string"},
            "description": "负责的目录命名空间"
          },
          "current_task": {
            "type": ["string", "null"],
            "description": "当前进行的 Spec ID，无任务时为 null"
          },
          "completed_specs": {
            "type": "array",
            "items": {"type": "string"},
            "description": "已完成的 Spec ID 列表"
          },
          "worktree": {
            "type": ["string", "null"],
            "description": "当前 worktree 路径"
          },
          "branch": {
            "type": ["string", "null"],
            "description": "当前分支名"
          }
        }
      }
    },
    "specs": {
      "type": "object",
      "description": "Spec 状态追踪",
      "additionalProperties": {
        "type": "object",
        "required": ["id", "name", "status", "dependencies"],
        "properties": {
          "id": {"type": "string", "description": "Spec ID (如 CORE-01)"},
          "name": {"type": "string", "description": "Spec 名称"},
          "status": {
            "type": "string",
            "enum": ["pending", "ready", "assigned", "in_progress", "completed", "blocked"],
            "description": "Spec 状态"
          },
          "dependencies": {
            "type": "array",
            "items": {"type": "string"},
            "description": "依赖的 Spec ID 列表"
          },
          "assignee": {
            "type": ["string", "null"],
            "description": "分配给的开发者"
          },
          "priority": {
            "type": "string",
            "enum": ["p0", "p1", "p2"],
            "description": "优先级"
          },
          "phase": {
            "type": "string",
            "description": "所属阶段 (Phase 0-7)"
          },
          "completed_at": {
            "type": ["string", "null"],
            "format": "date-time",
            "description": "完成时间"
          }
        }
      }
    },
    "locks": {
      "type": "object",
      "description": "文件锁状态",
      "additionalProperties": {
        "type": "object",
        "required": ["locked_by", "locked_at", "spec_id"],
        "properties": {
          "locked_by": {"type": "string"},
          "locked_at": {"type": "string", "format": "date-time"},
          "spec_id": {"type": "string"},
          "reason": {"type": "string"},
          "expires_at": {"type": "string", "format": "date-time"}
        }
      }
    },
    "worktrees": {
      "type": "array",
      "description": "活跃的 worktree 列表",
      "items": {
        "type": "object",
        "required": ["developer", "spec_id", "path", "branch"],
        "properties": {
          "developer": {"type": "string"},
          "spec_id": {"type": "string"},
          "path": {"type": "string"},
          "branch": {"type": "string"}
        }
      }
    },
    "milestones": {
      "type": "object",
      "description": "里程碑状态",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "name": {"type": "string"},
          "status": {"type": "string", "enum": ["pending", "in_progress", "completed"]},
          "completed_at": {"type": ["string", "null"], "format": "date-time"}
        }
      }
    }
  }
}
